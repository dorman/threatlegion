class Vulnerability < ApplicationRecord
  belongs_to :threat, optional: true

  validates :cve_id, presence: true, uniqueness: true, format: { with: /\ACVE-\d{4}-\d{4,}\z/, message: "must be valid CVE ID (e.g., CVE-2024-1234)" }
  validates :cvss_score, numericality: { greater_than_or_equal_to: 0, less_than_or_equal_to: 10 }, allow_nil: true

  scope :critical, -> { where("cvss_score >= ?", 9.0) }
  scope :high, -> { where("cvss_score >= ? AND cvss_score < ?", 7.0, 9.0) }
  scope :recent, -> { order(published_date: :desc) }

  def severity_level
    return "Unknown" if cvss_score.nil?
    
    case cvss_score
    when 9.0..10.0 then "Critical"
    when 7.0...9.0 then "High"
    when 4.0...7.0 then "Medium"
    when 0.1...4.0 then "Low"
    else "None"
    end
  end
end
